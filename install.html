<!DOCTYPE html>
<html>
  <head>
    <title>PROJ-JNI installation</title>
    <meta charset="UTF-8">
    <style>
      h2 {
        margin-top:    60px;
        padding:       6px 0;
        background:    OldLace;
        border-top:    1px solid DarkKhaki;
        border-bottom: 1px solid DarkKhaki;
        font-size:     large;
      }
      details {
        margin: 9px 25px;
      }
      details > summary {
        font-weight: bold;
      }
      pre {
        margin-left: 25px;
      }
      pre, code {
        font-family: "Courier New";
      }
      pre > var, code > var {
        font-family: "Sans serif";
        color: red;
      }
      body {
        margin-left:  80px;
        margin-right: 80px;
      }
    </style>
  </head>
  <body>
    <h1>PROJ-JNI installation</h1>
    <p>This guide describes the steps to execute for installing PROJ 6.2 and PROJ-JNI bindings.</p>




    <h2>Pre-requites</h2>
    <p>
      PROJ-JNI currently requires compilation from the source.
      The following compilation tools are pre-requites.
      Linux users can get those tools from their package manager.
    </p>
    <details>
      <summary>Linux (Fedora)</summary>
      <p>
        Execute in a console:
      </p>
      <pre>dnf install gcc-c++ make cmake java-latest-openjdk maven
export JAVA_HOME=/etc/alternatives/java_sdk</pre>
    </details>

    <details>
      <summary>Windows</summary>
      <p>
        Download and install (if not already done):
      </p>
      <ul>
        <li>g++</li>
        <li>make</li>
        <li>cmake</li>
        <li><a href="https://adoptopenjdk.net/">OpenJDK 13</a> or more recent</li>
        <li><a href="https://maven.apache.org/download.cgi">Maven</a> (to install, unzip in any directory)</li>
      </ul>
      <p>
        Execute in a console (keep that console for all operations in this page):
      </p>
      <pre>set MAVEN_HOME=<var>path_to_directory_where_Maven_has_been_unzipped</var>
set JAVA_HOME=<var>path_to_directory_where_Java_has_been_installed</var></pre>
    </details>




    <h2>Install PROJ</h2>
    <p>
      If PROJ 6.2.1 or a more recent version is available by the package managers of your platform,
      installation through that package manager is recommended
      (both <code>proj</code> and <code>proj-devel</code> packages are needed).
      In such case, the remaining of this section can be skipped.
      Otherwise if a previous PROJ version has been built locally, it should be uninstalled:
    </p>
    <details>
      <summary>Linux</summary>
      <p>
        Execute in the console (replace <var>6.2.0</var> by the actual version number of the PROJ version to uninstall):
      </p>
      <pre>cd <var>projects_directory</var>/proj-6.2.0
sudo make uninstall</pre>
    </details>
    <p>
      Get PROJ 6.2.1 or a more recent version from the <a href="https://proj.org/download.html">download page</a>.
      Then unzip and compile on the command line:
    </p>
    <details>
      <summary>Linux</summary>
      <p>
        Execute the following commands in the console (replace <var>6.2.1</var> by the actual version number).
        The installation directories will be under the <code>usr/local/</code> directory.
        It should not interfere with other PROJ versions installed by the package manager,
        which are typically directly under <code>usr/</code> directory.
      </p>
      <pre>cd <var>projects_directory</var>
# Move the downloaded PROJ file here before to continue
gunzip proj-6.2.1.tar.gz
tar -xf proj-6.2.1.tar
cd proj-6.2.1

# Following steps are reproduced from PROJ README file.
# See that file for more information on configuration options.
./configure
make
sudo make install
make check              # Optional, for checking that everything is all right.</pre>
    </details>

    <details>
      <summary>Windows</summary>
      <pre># (TODO - I presume unzipping is done from file explorer)
chdir <var>PROJ_directory</var>
# See README "Building with CMake". This is very different than the steps on Linux</pre>
    </details>




    <h2>Build PROJ-JNI</h2>
    <p>
      Download a <a href="https://github.com/Kortforsyningen/PROJ-JNI/packages">PROJ-JNI release</a>.
      (TODO: there is no release yet; use <code>git clone https://github.com/Kortforsyningen/PROJ-JNI.git</code> in the meantime)
      Unzip in a project directory then build the C/C++ code.
      Note that there is no "install" phase of PROJ-JNI; we keep the build local to the project directory.
    </p>
    <details>
      <summary>Linux</summary>
      <p>
        Execute the following commands in the console:
      </p>
      <pre>cd <var>projects_directory</var>/PROJ-JNI
mkdir target-native
cd target-native
cmake ../src/main/cpp
cd ..
cmake --build target-native
ldd src/main/resources/org/kortforsyningen/proj/linux/libproj-binding.so</pre>
      <p>
        The last line in above commands is for checking purpose.
        Its output should contain a line like below (details may vary):
      </p>
      <pre>libproj.so.15 => /lib64/libproj.so.15 (0x00007f19b6749000)</pre>
      <p>
        If the line shows "unknown" instead, the PROJ installation may be incomplete.
        How to fix the problem depends on the platform. On Fedora it can be fixed as below:
      </p>
      <pre>cd /lib64
sudo ln -s /usr/local/lib/libproj.so.15</pre>
    </details>

    <details>
      <summary>Windows</summary>
      <pre>TODO</pre>
    </details>
    <p>
      After the C/C++ part has been compiled, compiling the Java code can be done as below.
      This compilation includes a test phase, so a successful build means that the Java bindings
      have been correctly linked to PROJ.
    </p>
    <details open>
      <summary>Any platform</summary>
      <pre>mvn package</pre>
    </details>

    <details>
      <summary>Windows</summary>
      <p>
        It may be necessary to specify explicitly the path to Maven directory:
      </p>
      <pre>%MAVEN_HOME%\bin\mvn install</pre>
    </details>




    <h2>Test</h2>
    <p>
      A small test file is provided in the <code>example</code> directory and can be run as below.
      Note that there is no need to run <code>javac</code>;
      this will be done on-the-fly by the <code>java</code> command.
    </p>
    <details open>
      <summary>Any platform</summary>
      <pre>java --class-path target/proj-1.0-SNAPSHOT.jar example/TransformPoints.java</pre>
    </details>
  </body>
</html>
